<!doctype html>
<notebook>
  <title>Rename with Care</title>
  <script type="module">
   import * as frame from './frame.js';
   const frameInfo = Object.fromEntries(new URLSearchParams(window.location.hash.slice(1)).entries());
   const [frameProtocol, frameOrigin] = frameInfo.origin?.split('://') || [];
   const defaults = {
     protocol: 'http',
     site: 'wiki.dbbs.co',
     query: 'Apparatus'
   };
   let formatTitle = title => title;
   if (!!frameOrigin) {
     defaults.protocol = frameProtocol;
     defaults.site = frameOrigin;
     defaults.query = '';
     function click(title) {
       return event => {
         event.preventDefault();
         frame.link(title, event.shiftKey);
       };
     }
     formatTitle = title => html`<a href="#" data-title="${title}" onclick=${click(title)}>${title}</a>`;
   }
  </script>
  <script type="text/markdown">
    # Rename with Care
   ---
    1. specify the wiki site
  </script>
  <script type="module">
   const site = view(Inputs.form({
     protocol: Inputs.radio(['http', 'https'], {value: defaults.protocol}),
     domain: Inputs.text({value: defaults.site, submit: true, width: 80})
   }, {
     template: ({protocol, domain}) => html`
       <div style="display: flex; flex-direction: cols;">
         ${protocol}
         ${domain}
       </div>`
   }));
  </script>
  <script type="module">
   const sitemapUrl = new URL(`${site.protocol}://${site.domain}/system/sitemap.json`);
  </script>
  <script type="module">
   const sitemap = fetch(sitemapUrl)
     .then(res => res.json())
     .then(json => json.map(r => (r.date = new Date(r.date), r)))
     .catch(error => [{error}]);
  </script>
  <script type="text/markdown">
   ---
   2. choose which page to rename
  </script>
  <script type="module">
   const results = view(Inputs.search(await sitemap, {query: defaults.query}));
  </script>
  <script type="module">
   const selection = view(Inputs.table(results, {
     columns: ['title', 'date'],
     format: {title: formatTitle},
     value: results.reduce((max, item) => (item.date > max.date) ? item : max,
                           {date: new Date(0)}),
     header: {title: 'pages in sitemap'},
     sort: 'date',
     reverse: true,
     multiple: false
   }));
  </script>
  <script type="module">
   const slug = (await selection)?.slug;
   const pageUrl = new URL(`/${slug}.json`, sitemapUrl);
   const page = fetch(pageUrl)
     .then(res => res.json())
     .catch(error => {error});
   const fedwikisearchUrl = new URL(`${site.protocol}://query.search.federatedwiki.org/search`);
   fedwikisearchUrl.searchParams.set('find', 'links');
   fedwikisearchUrl.searchParams.set('within', 'pages');
   fedwikisearchUrl.searchParams.set('match', 'and');
   fedwikisearchUrl.searchParams.set('query', slug);
   const linksDiv = html`<div><em>...searching...</em>`;
   fetch(fedwikisearchUrl)
     .then(res => res.json())
     .then(json => {
       const markup = json.results;
       linksDiv.innerHTML = markup
                          ? markup
                          : `<em>No links found in the wider federation.</em>`;
     })
     .catch(error => linksDiv.append(html`${error}`));
  </script>
  <script type="text/markdown">
   ---
   3. Any local links to ${selection.title}?
  </script>
  <script type="module">
   await selection;
   const backlinks = sitemap.reduce((acc, pageInfo) => {
     if (pageInfo.links && !!(pageInfo.links[selection?.slug])) {
       acc.add(pageInfo)
     }
     return acc;
   }, new Set());
  </script>
  <script type="module">
   view(Inputs.table(backlinks, {
     columns: ['title', 'date'],
     header: {title: 'backlinks'},
     format: {title: formatTitle},
     sort: 'date',
     reverse: true,
     rows: 5.5
   }));
  </script>
  <script type="text/markdown">
   ---
   4. Any federation links to ${selection.title}?
  </script>
  <script type="module">
   display(linksDiv);
  </script>
  <script type="text/markdown">
   ---
   5. What title do you prefer?
  </script>
  <script type="module">
   const datalist = (await sitemap).map(p=>p.title);
   const title = view(Inputs.text({datalist}));
  </script>
  <script type="module">
   function preview(event) {
     event.preventDefault();
     const button = event.currentTarget;
     if (datalist.includes(title)) {
       button.value = 'A page with that name already exists.';
     } else {
       button.value = '';
       frame.open({...page, title}, event.shiftKey);
     }
     button.dispatchEvent(new Event('update'), {bubbles: true});
   };
   const previewButton = html`<button onclick=${preview}>Preview</button>`;
   const errorMessage = Generators.input(previewButton);
   view(previewButton);
  </script>
  <script type="module">
   display(html`<div style="color:red;">${errorMessage}`);
  </script>

</notebook>
