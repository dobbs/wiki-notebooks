<!doctype html>
<notebook>
  <title>Explore Renaming</title>
  <script type="module">
   const frameInfo = Object.fromEntries(new URLSearchParams(window.location.hash.slice(1)).entries());
   const [frameProtocol, frameOrigin] = frameInfo.origin?.split('://') || [];
   const defaults = {
     protocol: 'http',
     site: 'wiki.dbbs.co',
     query: 'Apparatus'
   };
   if (!!frameOrigin) {
     defaults.protocol = frameProtocol;
     defaults.site = frameOrigin;
     defaults.query = '';
   }
   display({defaults, frameInfo});
  </script>
  <script type="text/markdown">
    # Explore Renaming
   ---
    1. specify the wiki site
  </script>
  <script type="module">
   const form = view(Inputs.form({
     protocol: Inputs.radio(['http', 'https'], {value: defaults.protocol}),
     site: Inputs.text({value: defaults.site, submit: true, width: 80})
   }, {
     template: ({protocol, site}) => html`
       <div style="display: flex; flex-direction: cols;">
         ${protocol}
         ${site}
       </div>`
   }));
  </script>
  <script type="module">
   const sitemapUrl = new URL(`${form.protocol}://${form.site}/system/sitemap.json`);
  </script>
  <script type="module">
   const sitemap = fetch(sitemapUrl)
     .then(res => res.json())
     .then(json => json.map(r => (r.date = new Date(r.date), r)))
     .catch(error => [{error}]);
  </script>
  <script type="text/markdown">
   ---
   2. choose which page to rename
  </script>
  <script type="module">
   const results = view(Inputs.search(await sitemap, {query: defaults.query}));
  </script>
  <script type="module">
    const selection = view(Inputs.table(results, {
      columns: ['title', 'date'],
      value: results.reduce((max, item) => (item.date > max.date) ? item : max,
                            {date: new Date(0)}),
      header: {title: 'pages in sitemap'},
      sort: 'date',
      reverse: true,
      multiple: false
    }));
  </script>
  <script type="module">
   const slug = (await selection)?.slug;
   const pageUrl = new URL(`/${slug}.json`, sitemapUrl);
   const page = fetch(pageUrl)
     .then(res => res.json())
     .catch(error => {error});
   const fedwikisearchUrl = new URL('http://query.search.federatedwiki.org/search');
   fedwikisearchUrl.searchParams.set('find', 'links');
   fedwikisearchUrl.searchParams.set('within', 'pages');
   fedwikisearchUrl.searchParams.set('match', 'and');
   fedwikisearchUrl.searchParams.set('query', slug);
   const federationHtml = fetch(fedwikisearchUrl)
     .then(res => res.json())
     .then(json => {
       const markup = json.results;
       const div = html`<div>`;
       div.innerHTML = markup;
       return div;
     })
     .catch(error => html`${error}`);
  </script>
  <script type="text/markdown">
   ---
   3. update other pages that link here
  </script>
  <script type="module">
   await selection;
   const backlinks = sitemap.reduce((acc, pageInfo) => {
     if (pageInfo.links && !!(pageInfo.links[selection?.slug])) {
       acc.add(pageInfo)
     }
     return acc;
   }, new Set());
  </script>
  <script type="module">
   view(Inputs.table(backlinks, {
     columns: ['title', 'date'],
     header: {title: 'backlinks'},
     sort: 'date',
     reverse: true,
     rows: 5.5
   }));
  </script>
  <script type="text/markdown">
   ---
   4. consider pages from other sites
  </script>
  <script type="module">
   display(federationHtml);
  </script>
  <script type="module" pinned>
   const debug = {selection, page, backlinks};
   display(debug);
  </script>

</notebook>
